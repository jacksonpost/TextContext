<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta charset="utf-8">
	<title>textWall</title>
	<script type="text/javascript" src="scripts/jquery110.min.js"></script>
	<style>

	* {border:0;padding:0;margin:0;}
	body{
		/*font-family: helvetica, arial, sans-serif;*/
		font-family: garamond, georgia, serif;
		/*background:#f0f0f0;*/
		color:#222;
	}
	a {color:inherit; text-decoration: none;}

	#wrapper{
		width:100%;
		background: #fff;
		margin-top:1.3em;
	}

	#topNav{ 
		width:100%; 
		position: fixed; 
		top:0;
		background:#fff; 
		padding-left: 30%;
		z-index: 3;
	}
	#searchBox{
		background:#999;
		color:#fff;
		height:1.1em;
		display: inline-block;
		padding:0.1em;
		
	}
	#searchForm{display: inline-block;}
	#submitButton, #clearButton{display: inline-block; font-size: 0.8em;}
	#submitButton:hover, #clearButton:hover{cursor:pointer;color:#bbb;}

	#sentences {
		width:100%; 
		position:relative; 
		font-size: 1.3em;
	}

	#loading{width:10%; position:absolute; text-align:center; font-size: 1.3em; margin-left:45%; margin-top:10em;}

	</style>
</head>
<body>	

<script type="text/javascript">

/*

NOTES:

- mission:

*/


	var snippets=[];
	var stopArray= ["a", "about", "above", "after", "again", "against", "all", "am", "an", "and", "any", "are", "aren't", "as", "at", "be", "because", "been", "before", "being", "below", "between", "both", "but", "by", "can't", "cannot", "could", "couldn't", "did", "didn't", "do", "does", "doesn't", "doing", "don't", "down", "during", "each", "few", "for", "from", "further", "had", "hadn't", "has", "hasn't", "have", "haven't", "having", "he", "he'd", "he'll", "he's", "her", "here", "here's", "hers", "herself", "him", "himself", "his", "how", "how's", "i", "i'd", "i'll", "i'm", "i've", "if", "in", "into", "is", "isn't", "it", "it's", "its", "itself", "let's", "me", "more", "most", "mustn't", "my", "myself", "no", "nor", "not", "of", "off", "on", "once", "only", "or", "other", "ought", "our", "ours ", "ourselves", "out", "over", "own", "same", "shan't", "she", "she'd", "she'll", "she's", "should", "shouldn't", "so", "some", "such", "than", "that", "that's", "the", "their", "theirs", "them", "themselves", "then", "there", "there's", "these", "they", "they'd", "they'll", "they're", "they've", "this", "those", "through", "to", "too", "under", "until", "up", "very", "was", "wasn't", "we", "we'd", "we'll", "we're", "we've", "were", "weren't", "what", "what's", "when", "when's", "where", "where's", "which", "while", "who", "who's", "whom", "why", "why's", "with", "won't", "would", "wouldn't", "you", "you'd", "you'll", "you're", "you've", "your", "yours", "yourself", "yourselves"];
	var searchTerms = [];
	var searchJoined = "";
	var pageLimit=1;
	var pageSize=50;
	var backText;

	$(document).ready(function(){ 

		$('#submitButton').on('click',function(){
			searchTerms=[];
			var re = /\W+/;
			searchTerms = $('#searchBox').val().toLowerCase().split(re);
			searchIt();
		});
	 	$('#searchForm').on('submit',function(evt){ // just so you can submit with return key
	 		evt.preventDefault();
		    //window.history.back();
	 		searchTerms=[];
	 		var re = /\W+/;
	 		searchTerms = $('#searchBox').val().toLowerCase().split(re);
		 	searchIt();
	 	});
	 	$('#clearButton').on('click',function(){
			$('#searchBox').val("");
			$("#searchForm input").focus();
		});

	});

	function searchIt(){
		$('#loading').remove();
		var loader = $("<span id='loading'>loading...</span>").hide();
		$('body').append(loader);
		$('#loading').fadeIn();

		searchJoined = searchTerms.join(" ").toLowerCase();
		$('#searchBox').val(searchJoined);
		console.log("New search: "+searchJoined);
		getItems();
	}

	function getItems(){
		console.log("Getting items...");
		snippets=[];
		loadData(0,pageSize,searchJoined);
	}

	function compoundSearch(srch){
		searchTerms.push(srch);
		searchIt();
	}

	// custom function to get width of text
	$.fn.textWidth = function(text, font) {
	    if (!$.fn.textWidth.fakeEl) $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);
	    $.fn.textWidth.fakeEl.text(text || this.val() || this.text()).css('font', font || this.css('font'));
	    return $.fn.textWidth.fakeEl.width();
	};

	function loadData(pageN,pagelen,query){

		var sPoint=pageN*pagelen;

		console.log(query);
		var queryPhrase = "%22"+query+"%22";

		$.getJSON('http://api.trove.nla.gov.au/result?key=1ks0i5lp0mq6qj5s&zone=newspaper&reclevel=full&sortby=dateasc&q='+queryPhrase+'&encoding=json&include=articletext&n='+pagelen+'&s='+sPoint+'&callback=?', function(data) {
			//broken
			if(data.response){
				var item = data.response.zone[0].records.article;
				
				for (var i = 0; i< item.length; i++) {
					
					if(item[i].hasOwnProperty("snippet")){

						var applyMinus = false;
						var applyPlus = false;
						var str = $('<div/>').html(item[i].snippet).text(); // remove html formatting from the snippet
						var art = $('<div/>').html(item[i].articleText).text();
						var itemOb = {
							"number": sPoint+i,
							"heading": item[i].heading,
							"snippet": str,
							"fullText": art,
							"date": item[i].date,
							"url": item[i].troveUrl,
							"pdf": item[i].pdf
						}

						snippets.push(itemOb);

						// break snippet into three parts around first occurence of query term
						var patt=new RegExp(searchTerms[searchTerms.length-1],"i"); // case-insensitive
						var n = snippets[sPoint+i].snippet.search(patt);
						var pt1 = "";
						var pt2 = searchTerms[searchTerms.length-1];
						var pt3;
						var endQ = n+pt2.length;

						for(var j=0; j<snippets[sPoint+i].snippet.length;j++){
							if(j<n){
								pt1+=snippets[sPoint+i].snippet[j];
							}else if(j==n){
								if(snippets[sPoint+i].snippet[n-1]!=" "){ // force more consistent word spacing
									applyPlus = true;
								}else{applyPlus = false;}
							}else if(j>=endQ){
								if(j==endQ){
									if(snippets[sPoint+i].snippet[endQ]!=" "){ // force more consistent word spacing
										applyMinus = true;
									}else{applyMinus = false;}
								}
								pt3=snippets[sPoint+i].snippet.slice(j);
								break;
							}
						}


						// create stopword filtered array from full article text and make snippet links
						if(!snippets[sPoint+i].hasOwnProperty("stopSnip")){
							var re = /\W+/;
							var snipArray = snippets[sPoint+i].fullText.split(re);
							var mergedStop = stopArray.concat(searchTerms);
							var filtArray = snipArray.filter(function(w){ return mergedStop.indexOf(w.toLowerCase()) == -1});
							filtArray = filtArray.filter(function(w){ return w.length > 2}); // return true only for words not in the array stopwords
							filtArray.forEach(function(w){
								pt1 = pt1.replace(w,"<div class='snipLink' ident='"+(sPoint+i)+"'>" + w + "</div>");
								pt3 = pt3.replace(w,"<div class='snipLink' ident='"+(sPoint+i)+"'>" + w + "</div>");
							});
						}


						if(applyPlus){ // tighten spacing
							var lft = $("<span class='plusLetter' ident='"+(sPoint+i)+"'>"+pt1+"</span>").hide();
							$('.lCol').append(lft);
						}else{ 
							var lft = $("<span ident='"+(sPoint+i)+"'>"+pt1+"</span>").hide();
							$('.lCol').append(lft);
						}
						if(applyMinus){ // tighten spacing
							var rgt = $("<span class='minusLetter' ident='"+(sPoint+i)+"'>"+pt3+"</span>").hide()
							$('.rCol').append(rgt);
						}else{ 
							var rgt = $("<span ident='"+(sPoint+i)+"'>"+pt3+"</span>").hide()
							$('.rCol').append(rgt);
						}	
						if(n!=-1){ // if query is found in the snippet
							var mid = $("<span ident='"+(sPoint+i)+"'><a href='"+item[i].troveUrl+"' target='_blank'>"+pt2+"</a></span>").hide();
							$('.mCol').append(mid);
						}else{
							var mid = $("<span ident='"+(sPoint+i)+"'><a href='"+item[i].troveUrl+"' target='_blank'>||</a></span>").hide();
							$('.mCol').append(mid);
						}
					}
				}
			}else{
				console.log("NO RECORDS");
			}
		})
		.done(function(){
			console.log("Got JSON: Q: "+query+" P: "+pageN);

			if (pageN < pageLimit){
				loadData(pageN+1,pagelen,query);
			} else {
				console.log("finished loading");
			}
		})
		.fail(function() {
			console.log("JSON failed to load: Q: "+query+" P: "+pageN);
			$('#loading').remove();
			$('body').append("<span id='loading'>search failed, please try again</span>");
		});
	}

	function buildLabel(here){
		// Display the next exploration step on mouseover of word/sentence
		var ident = here.attr('ident');
		$('body').append("<div class='label'>"+snippets[ident].fullText+"</div>");
		//$('.label').hide();
		//$('.label').fadeIn();
		//$(here).replaceWith("<div class='label'><a class='labelButton'>+</a>"+here.html()+"<a class='labelButton'>*</a></div>");
		// $('.label a').on('click',function(){});
	}

/* OBSOLETE FUNCTIONS */

	function getStopwords()
	{
	    var rawFile = new XMLHttpRequest();
	    rawFile.open("GET", "data/stopWords/stop-words_english_2_en.txt", true);
	    rawFile.onreadystatechange = function ()
	    {
	        if(rawFile.readyState === 4)
	        {
	        	var rawText = rawFile.responseText;
	            stopArray = rawText.split('\n');
	            if(stopArray[stopArray.length-1]==""){stopArray.pop()}
	        }
	    }
	    rawFile.send();
	}

</script>

<h1></h1>
<div id="wrapper">

	<div id="topNav">
		<form id="searchForm">
			<input type="text" autofocus id="searchBox" name="search">
		</form>
		<span id="submitButton">submit</span>
		<span>|</span>
		<span id="clearButton">clear</span>
	</div>	
	<div id="sentences">
		<div class="lCol"></div>
		<div class="mCol"></div>
		<div class="rCol"></div>
	</div>
	<div id="sideNav"></div>
</div>

</body>